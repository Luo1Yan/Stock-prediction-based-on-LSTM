# Stock-prediction-based-on-LSTM

本项目提供了一个使用长短期记忆（LSTM）神经网络预测股票价格的完整工作流程。该脚本会生成模拟股票数据，使用 TensorFlow/Keras 构建和训练一个 LSTM 模型，评估其性能，并对未来价格进行预测。项目的一个关键特性是将这些预测与已知的“未来”数据集进行比较，以提供模型准确性的详细分析，其中还包括一个线性校准步骤以提高预测质量。
## 主要功能

- **模拟数据生成**: 创建具有潜在趋势、波动性和季节性的真实感股票价格数据。
- **多层 LSTM 模型**: 构建一个用于时间序列预测的堆叠式 LSTM 模型。
- **数据预处理**: 使用 `MinMaxScaler` 对数据进行归一化，并创建适合 LSTM 训练的序列。
- **模型训练与评估**:
  - 在历史数据集上训练模型。
  - 实现 **早停（Early Stopping）** 以防止过拟合，并保存最佳模型权重。
  - 使用标准回归指标（MSE, RMSE, MAE, MAPE）在测试集上评估模型。
- **未来预测**: 迭代地预测未来股价，将上一步的预测用作下一步的输入。
- **线性校准**: 在测试集的真实值与预测值之间拟合一个线性模型（`y_true ≈ a * y_pred + b`），并将此校准应用于未来预测，以纠正系统性偏差。
- **详细性能分析**:
  - 将30天的未来预测与真实情况进行比较。
  - 计算 **趋势方向准确率**（即模型是否正确预测了价格的上涨或下跌）。
  - 提供详细的统计数据，如平均/最大绝对误差和相对误差。
- **全面的可视化**:
  - 绘制训练数据、真实测试价格和预测价格。
  - 可视化预测误差的分布。
  - 显示训练和验证过程中的损失曲线。
  - 将未来预测与真实的未来价格直接进行比较。
  - 绘制未来预测期间的绝对误差图。
- **CSV 导出**: 将未来预测与现实情况的逐日详细比较保存到 `prediction_vs_reality_comparison.csv` 文件中。
## 依赖库

该项目依赖于以下 Python 库:

- `tensorflow`
- `pandas`
- `numpy`
- `scikit-learn`
- `matplotlib`
- `seaborn`

可以使用 `pip install -r requirements.txt` 一次性安装所有依赖。

## 输出

当您运行该脚本时，您将得到:

1.  **控制台输出**: 流程的逐步日志，包括数据生成、模型训练进度、评估指标和最终的预测分析。
2.  **Matplotlib 图表**: 将弹出多个窗口，显示“主要功能”部分描述的可视化图表。
3.  **CSV 文件**: 在根目录中将创建一个名为 `prediction_vs_reality_comparison.csv` 的文件。该文件包含未来30天期间预测价格与真实价格的逐日详细对比。

### CSV 输出示例 (`prediction_vs_reality_comparison.csv`)

| 日期         | 真实价格 | 预测价格 | 绝对误差 | 相对误差(%) | 预测方向 | 实际方向 | 方向正确 |
|--------------|----------|----------|----------|-------------|----------|----------|----------|
| 2022-09-27   | 196.72   | 194.52   | 2.20     | 1.12        | 上涨     | 上涨     | True     |
| 2022-09-28   | 201.98   | 193.84   | 8.14     | 4.03        | 下跌     | 上涨     | False    |
| ...          | ...      | ...      | ...      | ...         | ...      | ...      | ...      |


## 代码结构

整个逻辑被封装在 `StockPricePredictor` 类中，并由 `main()` 函数进行调度。

- **`StockPricePredictor` 类**:
  - `__init__(self, sequence_length)`: 初始化预测器、缩放器和模型。
  - `generate_stock_data(...)`: 生成模拟数据集。
  - `prepare_data(...)`: 为 LSTM 模型拆分和预处理数据。
  - `build_model(...)`: 定义堆叠式 LSTM 架构。
  - `train_model(...)`: 处理带早停功能的模型训练过程。
  - `predict(self, X)`: 对输入数据进行预测。
  - `evaluate_model(...)`: 计算并返回性能指标。
  - `calibrate_predictions(...)`: 找到线性校准参数 `a` 和 `b`。
  - `apply_calibration(...)`: 应用 `a * x + b` 变换。
  - `plot_results(...)`: 为测试集评估生成可视化图表。
  - `predict_future(...)`: 迭代地预测未来值。
  - `compare_predictions_with_reality(...)`: 创建详细的比较 DataFrame。
  - `print_prediction_analysis(...)`: 将最终分析打印到控制台。

- **`main()` 函数**:
  - 作为入口点，创建 `StockPricePredictor` 的实例，并按正确顺序调用其方法以执行完整的工作流程。

- **`if __name__ == "__main__":`**:
  - 确保只有在直接执行脚本时才调用 `main()` 函数。
